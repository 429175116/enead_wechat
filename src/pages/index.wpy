<style lang="less">
// 加载动画图片大小及位置
.indexloadImg{
  width:100rpx !important;
  height:100rpx !important;
  margin:330rpx !important;
}

.shopInfo{
  height: auto;
  color: #999;
  font-size: 30rpx;
  padding: 30rpx;
  margin-bottom:100rpx;
}
.shopName{
  font-weight: 700
}
.shopInfo view{
  height: auto;
  min-height: 50rpx;
  line-height: 50rpx;
}

.developerInfo{
  height: auto;
  color: #666;
  font-size: 20rpx;
  margin-top:300rpx;
  margin-bottom:130rpx;
  text-align: center;
}
.developerName{
  font-weight: 700
}
.developerInfo view{
  height: auto;
  min-height: 40rpx;
  line-height: 40rpx;
}
.developerPhone{
  display: inline-block;
}
.developerPhone view{
  width: 150rpx;
  display: inline-block;
}

.luckDraw {
  width:135rpx;
  height:93rpx;
  line-height:93rpx;
  background-color:rgba(0, 0, 0, 0.3);
  border-radius:100rpx 0 0 100rpx;
  position:fixed;
  bottom:356rpx;
  right:0rpx;
  text-align:center;
  font-size:25rpx;
  color:#fff;
}
.button-hover[type=primary] {
background-color: rgba(0, 0, 0, 0.3);
}
button[type=primary] {
  color:#FFFFFF;
  background-color: rgba(0, 0, 0, 0.3);
}

.shareIt{
  width: 90rpx;
  height: 90rpx;
  background-color: rgba(0, 0, 0, 0.3);
  border-radius: 50%;
  position: fixed;
  bottom: 250rpx;
  right: 20rpx;
  text-align: center;
  padding: 0;
  font-size: 0rpx;
  display: flex;
  justify-content: center;
  align-items: center; 
}

.luckDraw_img {
  width: 150rpx;
  height: 120rpx;
}

.service {
  width: 90rpx;
  height: 90rpx;
  background-color: rgba(0, 0, 0, 0.3);
  border-radius: 50%;
  position: fixed;
  bottom: 150rpx;
  right: 20rpx;
  text-align: center;
  display: flex;
  justify-content: center;
  align-items: center; 
}
 .shareIt image, .service_img {
  width: 60rpx;
  height: 60rpx;
  vertical-align:middle;
}

.appointment {
  position: absolute;
  top: 200rpx;
  left: 12.5%;
  // background: linear-gradient(to right, #ef3f22, #e98534, #e9bc34);
  background: linear-gradient(to right, #f86e09, #f29200, #f86e09);
  color: #fff;
  border-radius: 40rpx;
  font-size: 24rpx;
  width: 75%;
  height: 700rpx;
  padding: 0 60rpx;
  box-sizing: border-box;
  z-index: 3;
}

.title {
  margin-top: -80rpx;
  font-weight: bold;
}

.appointment_form {
  color: #fff;
  font-size: 24rpx;
}

.appointment_input {
  border: 4rpx #fff dashed;
  border-radius: 40rpx;
  height: 80rpx;
  box-sizing: border-box;
  padding: 0 40rpx;
  margin: 30rpx 0;
  color: #fff;
}

.appointment_img {
  position: relative;
  top: -80rpx;
  left: 120rpx;
  width: 230rpx;
  height: 124rpx;
}

.appointment_img1 {
  position: relative;
  top: -120rpx;
  left: 200rpx;
  width: 60rpx;
  height: 100rpx;
}

.mod_btn {
  margin: auto;
  border-radius: 50%;
  border: 6rpx solid #fff;
  background: rgba(0, 0, 0, 0);
  width: 130rpx;
  height: 130rpx;
  color: #fff;
  font-size: 30rpx;
  line-height: 120rpx;
  font-weight: bold;
}
.zhuan {
  position: absolute;
  top: 250rpx;
  left: 12.5%;
  z-index: 22;
}
.error {
  width: 40rpx;
  height: 40rpx;
  position: absolute;
  top: 220rpx;
  right: 18.5%;
  z-index: 22;
}
#getUserInfo{
  position: fixed;
  top: 0;
  width: 100% !important;
  height: 100% !important;
  padding: 0rpx !important;
  z-index: 999;
  background-color:rgba(255, 255, 255, 0);
  color: #fff;
}
.activity{
  width: 100%;
}
.getMoney{
  position: fixed;
  top: 300rpx;
  left: 75rpx;
  width: 600rpx;
  height: 600rpx;
}

.getMoney image{
  position: absolute;
  width: 600rpx;
  height: 600rpx;
}
.getMoney .infoShow{
  position: absolute;
  width: 360rpx;
  height: 340rpx;
  z-index: 1;
  bottom: 0;
  margin: 0 120rpx;
}
.hideGetMoneyImg{
  position: absolute;
  width: 50rpx;
  height: 50rpx;
  line-height: 50rpx;
  z-index: 1;
  top: 0;
  right: 85rpx;
  color: #fff;
  text-align: center;
}
.infoShow .moneyTitle{
  width: 100%;
  font-size: 40rpx;
  color: #fff;
  text-align: center;
}
.infoShow .moneyShow{
  width: 100%;
  height: 170rpx;
  font-size: 40rpx;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
}
.infoShow .moneyShow view:nth-child(1){
  text-align: right;
  font-size: 50rpx;
  height: 170rpx;
  line-height: 170rpx;
}
.infoShow .moneyShow view:nth-child(2){
  text-align: left;
  font-size: 20rpx;
  height: 170rpx;
  line-height: 190rpx;
}
.infoShow .button{
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.infoShow .button view, .infoShow .button button{
  width: 200rpx;
  height: 80rpx;
  border-radius: 30rpx;
  font-size: 30rpx;
  color: #fff;
  background-color: #f29200;
  margin: 0 5rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
</style>

<template>
  <view>
    <!-- 活动主图 -->
    <image src="{{image}}" bindtap="shareQRCodeImg" style="width:{{autoW}}px;height:{{autoH}}px" bindload='autoImage' class="activity {{indexloading}}" />
    <view class="shopInfo {{shopInfoShow?'show':'hidden'}}">
      <view class="shopName">{{shopName}}</view>
      <view @tap="dialPhone">电话:{{phone}}</view>
      <view>地址:{{address}}</view>
    </view>
    <view class="developerInfo">
      <view class="developerName">技术支持</view>
      <view>©2018 西安贝肯伟网络科技有限公司 版权所有</view>
      <view class="developerPhone">
        联系电话：
        <view @tap="developerPhone" data-phone="029-84498995">029-84498995</view>
        <!-- <view @tap="developerPhone" data-phone="029-68567800">029-68567800</view> -->
      </view>
      <view @tap="developerAddress">陕西省西安市高新区天谷八路软件新城研发基地二期A9栋405</view>
    </view>
    <!-- 活动 -->
    <view>
      <!-- 抽奖 -->
      <!-- <view class="luckDraw {{luckDrawData?'show':'hidden'}}">
        <image src="/img/luckDraw.png" @tap="goTurntable" class="luckDraw_img" />
      </view> -->
      <!-- <view class="luckDraw" @tap="goDescription">
        使用说明
      </view> -->
      <button class="shareIt" type="primary" open-type="share" data-name="pageShare" id="share">
        <image src="/img/shareIt.png" class="service_img" />
      </button>
      <view class="luckDraw" @tap="goDescription">
        使用说明
      </view>
      <!-- 联系客服 -->
      <view class='service'>
        <image src="/img/phone.png" @tap="dialPhone" class="service_img" />
      </view>
    </view>
    <!-- 红包领取提示 -->
    <!-- <view class="getMoney"> -->
    <view class="getMoney" wx:if="{{titleMoneyImg}}">
      <view class="hideGetMoneyImg"  @tap="hideGetMoneyImg">ⓧ</view>
      <image src="/img/{{moneyImg}}.png" />
      <view class="infoShow">
        <view class="moneyTitle">恭喜获得红包</view>
        <view class="moneyShow">
          <view>{{getMoney}}</view>
          <view>元</view>
        </view>
        <view class="button">
          <view @tap="walletIn">查看</view>
          <button type="primary" open-type="share" data-name="pageShare" id="share">
            分享
          </button>
        </view>
      </view>
    </view>
    <view>
      <button open-type="getUserInfo" class='{{authorizationButton}}' id='getUserInfo' lang="zh_CN" @getuserinfo="onGotUserInfo">{{time}}</button>
    </view>
    <nav @childFn.user="goPage" />
  </view>
</template>


// customData = {}  // 自定义数据
// customFunction ()　{}  // 自定义方法
// onLoad () {}  // 在Page和Component共用的生命周期函数
// onShow () {}  // 只在Page中存在的页面生命周期函数
// config = {};  // 只在Page实例中存在的配置数据，对应于原生的page.json文件
// data = {};  // 页面所需数据均需在这里声明，可用于模板数据绑定
// components = {};  // 声明页面中所引用的组件，或声明组件中所引用的子组件
// mixins = [];  // 声明页面所引用的Mixin实例
// computed = {};  // 声明计算属性（详见后文介绍）
// watch = {};  // 声明数据watcher（详见后文介绍）
// methods = {};  // 声明页面wxml中标签的事件处理函数。注意，此处只用于声明页面wxml中标签的bind、catch事件，自定义方法需以自定义方法的方式声明
// 普通自定义方法在methods对象外声明，与methods平级
// events = {};  // 声明组件之间的事件处理函数
//props  {传值}  在WePY中属于  父子组件之间  传值的一种机制

// 页面跳转，传参写法
// this.$redirect('./page2', {a: 1, b: 2})
// this.$redirect({
//   url: './pages?a=1&b=2'
// });
// this.$navigate(url)

// 水平垂直居中
// display: flex;
// align-items: center;
// justify-content: center;

// 居右
// flex-direction:row;
// justify-content:flex-end

// vertical-align:middle;

// overflow:hidden;
// text-overflow:ellipsis;
// white-space:nowrap;

// 自动换行
// word-break:break-all;

// overflow:hidden;
// text-overflow:ellipsis;
// white-space:nowrap;
<script>
import wepy from 'wepy'
import nav from '../components/nav' // 底部导航
// import author from '../components/author' // 授权按钮
export default class Index extends wepy.page {
  config = {
    'navigationBarTitleText': '共享广告助手'
  };
  // 生命组件ID
  components = {
    // 底部导航
    nav: nav
  };
  // alias example
  data = {
    userInfo: null,
    authorizationButton: '',
    thisShare: null,
    code: null,
    image: '',
    // image: '/img/indexLoading.gif',
    advertisingName: '',
    money: '',
    share: '',
    phone: '',
    address: '',
    shopName: '',
    luckDrawData: false,
    autoW: null,
    autoH: null,
    uuid: null,
    time: '',
    indexloading: '',
    shopInfoShow: false,
    titleMoneyImg: false, // 控制红包提示图片显示
    moneyImg: 'getMoneyBg', // 红包领取提示图片内容
    getMoney: 0.00 // 获取红包金额
  };

  methods = {
    // 底部导航跳转
    goPage (url, evt) {
      // 销毁当前页{跳转}
      this.$redirect(url)
    },
    // 跳转至转盘页
    goTurntable () {
      // 不销毁当前页{跳转} 可返回
      this.$navigate('/pages/turntable')
    },
    // 点击图片放大，长按后可操作
    shareQRCodeImg(e) {
      wx.previewImage({
        current: [this.image], // 当前显示图片的http链接   
        urls: [this.image] // 需要预览的图片http链接列表   
      })
    },
    // 拨打商家电话
    dialPhone() {
      if (this.phone) {
        wx.makePhoneCall({
          phoneNumber: this.phone,
          success: function () {
            console.log('拨打电话成功！')
          },
          fail: function () {
            console.log('拨打电话失败！')
          }
        })
      }
    },
    // 拨打公司电话
    developerPhone(e) {
      let phone = e.target.dataset.phone
      if (phone) {
        wx.makePhoneCall({
          phoneNumber: phone,
          success: function () {
            console.log('拨打电话成功！')
          },
          fail: function () {
            console.log('拨打电话失败！')
          }
        })
      }
    },
    // 公司地址导航
    developerAddress(e) {
      wx.openLocation({
        latitude: 34.2060500000,
        longitude: 108.8356100000,
        name: '贝肯伟网络科技有限公司',
        address: '陕西省西安市高新区天谷八路软件新城研发基地二期A9栋405'
      })
    }
  };
  async onGotUserInfo() {
    // 获取用户信息
    this.userInfo = await wepy.getUserInfo()
    this.userInfo = this.userInfo.rawData
    // 判断用户信息是否为空
    if (this.userInfo) {
      this.authorizationButton = 'hide'
      // 数据生效
      this.$apply()
      // 提交用户信息
      this.setUserInfo(this.userInfo)
    }
    // wx.getSetting({
    //   success(res) {
    //     // 判断是否已经授权
    //     this.scopeUserInfo = res.authSetting['scopeUserInfo']
    //     // if (res.authSetting['scope.userInfo']) {
    //     //   // 用户已经授权获取用户ID
    //     // }
    //   }
    // })
    this.userInfo = await wepy.getUserInfo()
    this.userInfo = this.userInfo.rawData
    this.userInfo = JSON.parse(this.userInfo)
    this.$parent.globalData.userInfo = this.userInfo
    // 如果没有分享的广告，则获取自己的广告
    if (!this.uuid) {
      this.uuid = this.$parent.globalData.uuid
    }
    // 店铺标识
    // 如果uuid不为空则店铺存在;或者options.share不为空,则分享的广告不为空
    // 空则显示默认图,非空则显示加载动画,然会去请求广告信息,然后显示广告页
    if (this.uuid) {
      // 若不是分享进入小程序，则执行此处,没有延迟执行和倒计时
      // 默认图不显示,在请求拿到数据前加入loading图片
      this.indexloading = 'indexloadImg'
      this.image = '/img/indexLoading.gif'
      // 隐藏授权按钮
      this.authorizationButton = 'hide'
      // 数据生效
      this.$apply()
    }
    this.$apply()
    await wepy.login().then(res => {
      this.code = res.code
    })
    // 广告页显示
    await wx.request({
      url: `${this.$parent.globalData.requestUrl}/ad/show`,
      method: 'POST',
      data: {
        code: this.code,
        uuid: this.uuid
      },
      success: data => {
        if (data.statusCode === 200) {
          // 显示底部店铺信息
          this.shopInfoShow = true
          this.indexloading = ''
          data = data.data
          this.$parent.globalData.guangGao = data
          this.image = data.ad
          this.advertisingName = data.ad
          this.money = data.step
          this.phone = data.phone
          this.thisShare = data.share
          this.uuid = data.uuid
          this.address = data.address
          this.shopName = data.name
          this.title = data.title
          this.$parent.globalData.uuid = data.uuid
          this.$apply()
          // 转盘展示功能暂时屏蔽
          // this.getlotteryInfo()
        }
      }
    })
    setTimeout(e => {
      // uuid为空则不执行领取红包
      if (!this.uuid) {
        return
      }
      wepy.login().then(res => {
        this.code = res.code
        // 领取红包
        wx.request({
          url: `${this.$parent.globalData.requestUrl}/wallet/in`,
          method: 'POST',
          data: {
            code: this.code,
            uuid: this.uuid,
            share: this.share
          },
          success: data => {
            console.log(data)
            if (data.data.status_code === 400) {
              wx.showModal({
                title: '',
                content: data.data.message,
                showCancel: false
              })
            }
            if (data.data.status_code !== 400) {
              this.getMoney = data.data.data[0]
              this.$apply()
              this.titleMoneyImg = true // 控制红包提示图片显示
              this.moneyImg = 'getMoneyBg'  // 红包领取提示图片内容
              this.$apply()
              wx.playBackgroundAudio({
                dataUrl: `${this.$parent.globalData.imgUrl}/music/gold.mp3`,
                title: '',
                coverImgUrl: ''
              })
              // wx.showModal({
              //   title: '',
              //   content: `恭喜你获得了${data.data.data[0]}元红包，进入个人中心查看`,
              //   showCancel: false
              // })
            }
          }
        })
      })
    }, 1000)
  }
  async onLoad(options) {
    this.image = this.$parent.globalData.imgUrlMain
    this.$apply()
    // 获取用户信息
    this.userInfo = await wepy.getUserInfo()
    this.userInfo = this.userInfo.rawData
    // 判断用户信息是否为空
    if (this.userInfo) {
      // 分享人
      this.share = options.share
      // 分享广告的UUID
      this.uuid = options.uuid
      this.onGotUserInfo()
    }
  };
  // 隐藏红包提示图片
  hideGetMoneyImg() {
    this.titleMoneyImg = false
    this.$apply()
  }
  onLaunch() {
    wepy.login().then(res => {
      console.log('login: ', res)
    })
  };
  // 分享页面
  onShareAppMessage() {
    // let pages = getCurrentPages() // 获取加载的页面
    // let currentPage = pages[pages.length - 1] // 获取当前页面的对象
    // let url = currentPage.route // 当前页面url
    let url = `pages/index?share=${this.thisShare}&uuid=${this.uuid}`
    this.hideGetMoneyImg()
    return {
      title: this.title,
      desc: '',
      imageUrl: this.image,
      path: url
    }
  };
  // 控制背景图大小
  autoImage(e) {
    // 获取图片的狂傲
    var imgW = e.detail.width
    var imgH = e.detail.height
    // 计算图片比例
    var imgScale = imgW / imgH
    // 声明自适应宽高变量
    var autoW = ''
    var autoH = ''
    // 获取屏幕宽度，并将图片设置为屏幕等宽
    wx.getSystemInfo({
      success: res => {
        autoW = res.windowWidth
        autoH = autoW / imgScale
        this.autoW = autoW
        this.autoH = autoH
        this.$apply()
      }
    })
  }
  async setUserInfo(userInfo) {
    // 从组件中获取userInfo
    await wepy.login().then(res => {
      this.code = res.code
    })
    // 获取用户信息
    this.userInfo = JSON.parse(userInfo)
    this.$parent.globalData.userInfo = JSON.parse(userInfo)
    // 发送请求,存储用户信息
    await wx.request({
      url: `${this.$parent.globalData.requestUrl}/user/store`,
      method: 'POST',
      data: {
        code: this.code,
        nick_name: this.userInfo.nickName,
        sex: this.userInfo.gender,
        avatar: this.userInfo.avatarUrl
      },
      success: function (data) {}
    })
  }
  // 获取活动状态
  getlotteryInfo() {
    wepy.login().then(res => {
      this.code = res.code
      // 查看广告页抽奖状态，控制跳转按钮是否显示
      wx.request({
        url: `${this.$parent.globalData.requestUrl}/lottery/show`,
        method: 'POST',
        data: {
          code: this.code,
          uuid: this.uuid
        },
        success: data => {
          // 400为无效活动，活动未新建，不显示转盘跳转按钮
          if (data.data.status_code === 200) {
            this.luckDrawData = true
            this.$apply()
            this.$parent.globalData.awards = data.data.data
          } else {
            this.$parent.globalData.lotteryMessage = data.data.message
          }
        }
      })
    })
  }
  // 进入使用说明页
  goDescription() {
    this.$navigate('/pages/description')
  };
  // 钱包入账明细
  walletIn() {
    this.hideGetMoneyImg()
    this.$navigate('/pages/userWalletIn')
  };
}
</script>