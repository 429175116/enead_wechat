<style lang="less">
  // 加载动画图片大小及位置
.indexloadImg{
  width:100rpx !important;
  height:100rpx !important;
  margin:330rpx !important;
}

.shopInfo{
  height: auto;
  color: #999;
  font-size: 30rpx;
  padding: 30rpx;
  margin-bottom:100rpx;
}
.shopName{
  font-weight: 700
}
.shopInfo view{
  height: auto;
  min-height: 50rpx;
  line-height: 50rpx;
}

.luckDraw {
  width:135rpx;
  height:93rpx;
  line-height:93rpx;
  background-color:rgba(0, 0, 0, 0.3);
  border-radius:100rpx 0 0 100rpx;
  position:fixed;
  bottom:356rpx;
  right:0rpx;
  text-align:center;
  font-size:25rpx;
  color:#fff;
}
.button-hover[type=primary] {
background-color: rgba(0, 0, 0, 0.3);
}
button[type=primary] {
  color:#FFFFFF;
  background-color: rgba(0, 0, 0, 0.3);
}

.shareIt{
  width: 90rpx;
  height: 90rpx;
  background-color: rgba(0, 0, 0, 0.3);
  border-radius: 50%;
  position: fixed;
  bottom: 250rpx;
  right: 20rpx;
  text-align: center;
  padding: 0;
  font-size: 0rpx;
  display: flex;
  justify-content: center;
  align-items: center; 
}

.luckDraw_img {
  width: 150rpx;
  height: 120rpx;
}

.service {
  width: 90rpx;
  height: 90rpx;
  background-color: rgba(0, 0, 0, 0.3);
  border-radius: 50%;
  position: fixed;
  bottom: 150rpx;
  right: 20rpx;
  text-align: center;
  display: flex;
  justify-content: center;
  align-items: center; 
  color: #fff;
}

.appointment {
  position: absolute;
  top: 200rpx;
  left: 12.5%;
  // background: linear-gradient(to right, #ef3f22, #e98534, #e9bc34);
  background: linear-gradient(to right, #f86e09, #f29200, #f86e09);
  color: #fff;
  border-radius: 40rpx;
  font-size: 24rpx;
  width: 75%;
  height: 700rpx;
  padding: 0 60rpx;
  box-sizing: border-box;
  z-index: 3;
}

.title {
  margin-top: -80rpx;
  font-weight: bold;
}

.appointment_form {
  color: #fff;
  font-size: 24rpx;
}

.appointment_input {
  border: 4rpx #fff dashed;
  border-radius: 40rpx;
  height: 80rpx;
  box-sizing: border-box;
  padding: 0 40rpx;
  margin: 30rpx 0;
  color: #fff;
}

.appointment_img {
  position: relative;
  top: -80rpx;
  left: 120rpx;
  width: 230rpx;
  height: 124rpx;
}

.appointment_img1 {
  position: relative;
  top: -120rpx;
  left: 200rpx;
  width: 60rpx;
  height: 100rpx;
}

.mod_btn {
  margin: auto;
  border-radius: 50%;
  border: 6rpx solid #fff;
  background: rgba(0, 0, 0, 0);
  width: 130rpx;
  height: 130rpx;
  color: #fff;
  font-size: 30rpx;
  line-height: 120rpx;
  font-weight: bold;
}
.zhuan {
  position: absolute;
  top: 250rpx;
  left: 12.5%;
  z-index: 22;
}
.error {
  width: 40rpx;
  height: 40rpx;
  position: absolute;
  top: 220rpx;
  right: 18.5%;
  z-index: 22;
}
#getUserInfo{
  position: fixed;
  top: 0;
  width: 100% !important;
  height: 100% !important;
  padding: 0rpx !important;
  z-index: 999;
  background-color:rgba(255, 255, 255, 0);
  color: #fff;
}
.activity{
  width: 100%;
}
.getMoney{
  position: fixed;
  top: 300rpx;
  left: 75rpx;
  width: 600rpx;
  height: 600rpx;
}

.getMoney image{
  position: absolute;
  width: 600rpx;
  height: 600rpx;
}
.getMoney .infoShow{
  position: absolute;
  width: 360rpx;
  height: 340rpx;
  z-index: 1;
  bottom: 0;
  margin: 0 120rpx;
}
.hideGetMoneyImg{
  position: absolute;
  width: 50rpx;
  height: 50rpx;
  line-height: 50rpx;
  z-index: 1;
  top: 0;
  right: 85rpx;
  color: #fff;
  text-align: center;
}
.infoShow .moneyTitle{
  width: 100%;
  font-size: 40rpx;
  color: #fff;
  text-align: center;
}
.infoShow .moneyShow{
  width: 100%;
  height: 170rpx;
  font-size: 40rpx;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
}
.infoShow .moneyShow view:nth-child(1){
  text-align: right;
  font-size: 50rpx;
  height: 170rpx;
  line-height: 170rpx;
}
.infoShow .moneyShow view:nth-child(2){
  text-align: left;
  font-size: 20rpx;
  height: 170rpx;
  line-height: 190rpx;
}
.infoShow .button{
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.infoShow .button view, .infoShow .button button{
  width: 200rpx;
  height: 80rpx;
  border-radius: 30rpx;
  font-size: 30rpx;
  color: #fff;
  background-color: #f29200;
  margin: 0 5rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}
// swiper,swiper-item{
//   height: auto;
// }
</style>
<template>
  <view>
    <!-- 活动主图 -->
    
    <!-- <swiper class='swiper' indicator-dots="true" autoplay='true' interval='5000' duration='2000'>
      <repeat for="{{defaultAd}}" item="item" key="index" index="index">
        <swiper-item>
          <image src="{{item}}" style="width:{{autoW[index]}}px;height:{{autoH[index]}}px" data-index="{{index}}" data-image="{{item}}" bindload='autoImage' @tap="shareQRCodeImg" />
        </swiper-item>
      </repeat>
    </swiper> -->
    <!-- <view> -->
      <repeat for="{{defaultAd}}" key="index" index="index" item="item">
        <image src="{{item}}" data-index="{{index}}" data-image="{{item}}" @tap="shareQRCodeImg" style="width:{{autoW[index]}}px;height:{{autoH[index]}}px" bindload='autoImage' />
      </repeat>
    <!-- </view> -->
    <view class="shopInfo {{shopinfo.shopName != ''?'show':'hidden'}}">
      <view class="shopName">{{shopInfoShow.shopName}}</view>
      <view @tap="dialPhone" data-phone="{{shopInfoShow.phone}}">电话:{{shopInfoShow.phone}}</view>
      <view>地址:{{shopInfoShow.address}}</view>
    </view>
    <!-- 活动 -->
    <view>
      <button class="shareIt" type="primary" open-type="share" data-name="pageShare" id="share">
        <icon class="iconfont icon-fenxiang"></icon>
      </button>
      <view class="luckDraw" @tap="goDescription">
        使用说明
      </view>
      <!-- 联系客服 -->
      <view class='service iconfont icon-dianhua' @tap="dialPhone" data-phone="{{shopinfo.phone}}"></view>
    </view>
    <!-- 红包领取提示 -->
    <!-- <view class="getMoney"> -->
    <view class="getMoney" wx:if="{{titleMoneyImg}}">
      <view class="hideGetMoneyImg"  @tap="hideGetMoneyImg">ⓧ</view>
      <image src="/img/getMoneyBg.png" />
      <view class="infoShow">
        <view class="moneyTitle">恭喜获得红包</view>
        <view class="moneyShow">
          <view>{{getMoney}}</view>
          <view>元</view>
        </view>
        <view class="button">
          <view @tap="walletIn">查看</view>
          <button type="primary" open-type="share" data-name="pageShare" id="share">
            分享
          </button>
        </view>
      </view>
    </view>
    <view>
      <button open-type="getUserInfo" wx:if='{{getUserInfoButShow}}' id='getUserInfo' lang="zh_CN" @getuserinfo="onGetUserInfo"></button>
    </view>
    <nav @childFn.user="goPage" />
  </view>
</template>

<script>
  import wepy from 'wepy'
  import nav from '../components/nav' // 底部导航
  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '广告首页'
    }
    components = {
      nav: nav
    }

    mixins = []

    data = {
      userInfo: {},
      requestImgUrl: '',
      // defaultAd: ['http://www.enuoe.cn/enuoe/ene_h.jpg','http://www.enuoe.cn/enuoe/ene_zs.png'],
      defaultAd: ['http://www.enuoe.cn/enuoe/ene.jpg'],
      autoW: [],
      autoH: [],
      shopInfoShow: {
        "id": "",
        "shopName": "西安一诺尔软件有限公司",
        "phone": "029-85798937",
        "address": "陕西省西安市沣东新城协同创新港研发办公楼A座8层-60号",
      },
      getUserInfoButShow: true,
      adId: '',
      uuid: '',
      titleMoneyImg: false,
      getMoney: ''
    }

    computed = {
      
    }

    methods = {
      // 底部导航跳转
      goPage (url, evt) {
        // 销毁当前页{跳转}
        this.$redirect(url)
      },
      // 进入使用说明页
      goDescription() {
        this.$navigate('/pages/description')
      },
      // 点击图片放大，长按后可操作
      shareQRCodeImg(e) {
        // 点击图片放大
        this.shareQRCodeImg(e)
      },
      dialPhone(e) {
        // 拨打电话执行
        this.dialPhoneRun(e)
      },
      hideGetMoneyImg() {
        this.titleMoneyImg = false
        this.$apply()
      },
      walletIn() {
        this.$navigate('/pages/userWalletIn')
      }
    }

    onLoad(options) {
      this.userInfo = this.$parent.globalData.userInfo
      this.requestImgUrl = this.$parent.globalData.requestImgUrl
            
      // 获取商家信息
      this.getShopInfo()
      // 更新用户信息，并获取用户信息
      this.onGetUserInfo()
      var optionsNode = Object.keys(options);
      if (optionsNode.length > 0) {
        this.adId = options.id
        this.uuid = options.uuid
        this.shopInfoShow = {
          'id': options.shopid,
          'shopName': options.shopname,
          'phone': options.phone,
          'address': options.address,
        }
        if (options.id) {
          this.getAdInfo(options.id)
        }
      }
      wx.setNavigationBarTitle({
        title: this.shopInfoShow.shopName
      })
    }
    getAdInfo(id) {
      wx.request({
        url: `${this.$parent.globalData.requestUrl}getAdver`,
        method: 'GET',
        data: {
          'dto.adver.id': id
        },
        success: data => {
          data = this.$parent.null2str(data.data.dto)
          if (data.result === '0') {
            this.adInfo = data.adver
            this.defaultAd = [this.adInfo.ad]
            this.$apply()
            setTimeout(e => {
              wx.getSetting({
                success: res => {
                  if (res.authSetting['scope.userInfo']) {
                    // 已经授权，可以直接调用 getUserInfo 获取头像昵称
                    this.lookAdver(id)
                  } else {
                    wepy.showModal({
                      title: '',
                      content: '未授权不可领取红包',
                      showCancel: false
                    })
                  }
                }
              })
              
            }, 5000)
          } else {
            wepy.showModal({
              title: '',
              content: data.msg,
              showCancel: false
            })
          }
        }
      })
    }
    lookAdver(id) {
      wx.request({
        url: `${this.$parent.globalData.requestUrl}lookAdver`,
        method: 'GET',
        data: {
          'dto.adver.id': id,
          'dto.openid': this.userInfo.openid
        },
        success: data => {
          console.log(data)
          data = this.$parent.null2str(data.data.dto)
          if (data.result === '0') {
            this.getMoney = data.adverBalanceOutDetail.outnum
            this.titleMoneyImg = true
            wx.playBackgroundAudio({
              dataUrl: `https://bkwhb.beaconway.cn/music/gold.mp3`,
              title: '',
              coverImgUrl: ''
            })
            this.$apply()
            if (this.uuid) {
              this.shareAdver(this.uuid)
            }
          } else {
            wepy.showModal({
              title: '',
              content: data.msg,
              showCancel: false
            })
          }
        }
      })
    }
    shareAdver() {
      wx.request({
        url: `${this.$parent.globalData.requestUrl}shareAdver`,
        method: 'GET',
        data: {
          'dto.shareAdver.openid': this.shopInfoShow.id,
          'dto.shareAdver.shopId': this.userInfo.openid,
          'dto.shareAdver.ad.id': id,
          'dto.shareAdver.shareOpenid': this.userInfo.openid
        },
        success: data => {
          data = this.$parent.null2str(data.data.dto)
          if (data.result === '0') {
            
          } else {
            // wepy.showModal({
            //   title: '',
            //   content: data.msg,
            //   showCancel: false
            // })
          }
        }
      })
    }
    getShopInfo() {
      // this.shopinfo = {
      //   'id': '1',
      //   'shopName': '商家名称',
      //   'phone': '18888888888',
      //   'address': '沣东',
      // }
    }
    dialPhoneRun(e) {
      // 拨打电话执行
      let phone = e.target.dataset.phone
      if (phone) {
        wx.makePhoneCall({
          phoneNumber: phone,
          success: function () {
            console.log('拨打电话成功！')
          },
          fail: function () {
            console.log('拨打电话失败！')
          }
        })
      }
    }
    shareQRCodeImg(e) {
      // 点击图片放大
      let imageUrl = e.target.dataset.image
      wx.previewImage({
        current: [imageUrl], // 当前显示图片的http链接   
        urls: [imageUrl] // 需要预览的图片http链接列表   
      })
    }
    // 控制背景图大小
    autoImage(e) {
      let index = e.target.dataset.index
      // 获取图片的狂傲
      var imgW = e.detail.width
      var imgH = e.detail.height
      // 计算图片比例
      var imgScale = imgW / imgH
      // 声明自适应宽高变量
      var autoW = 0
      var autoH = 0
      // 获取屏幕宽度，并将图片设置为屏幕等宽
      wx.getSystemInfo({
        success: res => {
          autoW = res.windowWidth
          autoH = autoW / imgScale
          // console.log(autoW,autoH)
          this.autoW[index] = autoW
          this.autoH[index] = autoH
          console.log(this.autoW)
          console.log(this.autoH)
          this.$apply()
        }
      })
    }
    async onGetUserInfo() {
      wx.getUserInfo({
        success: res => {
          this.userInfo = res.userInfo
          this.$parent.globalData.userInfo = this.userInfo
          this.getUserInfoButShow = false
          // 数据生效
          this.$apply()
          this.setUserInfo(this.userInfo)
          
        }
      })
    }
    async setUserInfo(userInfo) {
      // 获取用户信息
      this.userInfo = userInfo
      this.$parent.globalData.userInfo = userInfo
      // 发送请求,存储用户信息
      wx.login({
        success: res => {
          wx.request({
            url: `${this.$parent.globalData.requestUrl}userSave`,
            method: 'GET',
            data: {
              'dto.wechatCode': res.code,
              'dto.normalUser.nickName': this.userInfo.nickName,
              'dto.normalUser.nickName': encodeURI(this.userInfo.nickName),
              'dto.normalUser.province': this.userInfo.province,
              'dto.normalUser.sex': this.userInfo.gender
            },
            success: data => {
              data = this.$parent.null2str(data.data.dto)
              if (data.result === '0') {
                // JSON合并
                this.userInfo = Object.assign({}, data.normalUser, this.userInfo)
                this.userInfo = Object.assign({}, data.wallet, this.userInfo)
                this.$parent.globalData.userInfo = this.userInfo
                if ('shop' in data) {
                  this.shopInfo = data.shop
                  this.$parent.globalData.shopInfo = this.shopInfo
                } else {
                  this.$parent.globalData.shopInfo = null
                }
              } else {
                wx.showModal({
                  title: '',
                  content: data.msg,
                  showCancel: false
                })
              }
            }
          })
        }
      })
    }
    // 分享页面
    onShareAppMessage(res) {
      console.log(this.shopInfoShow.id)
      console.log(this.shopInfoShow.shopName)
      console.log(this.shopInfoShow.phone)
      console.log(this.shopInfoShow.address)
      console.log(this.adId)
      console.log(this.userInfo.openid)
      let url = `pages/index?shopname=${this.shopInfoShow.shopName}&phone=${this.shopInfoShow.phone}&address=${this.shopInfoShow.address}&id=${this.adId}&uuid=${this.userInfo.openid}`
      console.log(url)
      return {
        // this.adInfo.name
        title: this.shopInfoShow.shopName,
        desc: '',
        // 图片路径
        imageUrl: this.defaultAd[0],
        path: url
      }
    };
  }
</script>
